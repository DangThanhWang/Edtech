// server/src/controllers/studySessionController.js
const StudySession = require('../models/StudySession');
const StudySet = require('../models/StudySet');
const User = require('../models/User');

const studySessionController = {
  // Start new study session
  startSession: async (req, res) => {
    try {
      const { studySetId } = req.params;
      const { sessionType = 'flashcard', settings = {} } = req.body;

      console.log('üéØ Starting study session:', { studySetId, sessionType, userId: req.user.id });

      // Get study set
      const studySet = await StudySet.findById(studySetId);
      if (!studySet) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y h·ªçc ph·∫ßn'
        });
      }

      // Check access permissions
      if (studySet.privacy === 'private' && studySet.creator.toString() !== req.user.id.toString()) {
        return res.status(403).json({
          success: false,
          message: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p h·ªçc ph·∫ßn n√†y'
        });
      }

      // Check if study set has cards
      if (!studySet.cards || studySet.cards.length === 0) {
        return res.status(400).json({
          success: false,
          message: 'H·ªçc ph·∫ßn kh√¥ng c√≥ th·∫ª n√†o ƒë·ªÉ h·ªçc'
        });
      }

      // Create new study session
      const session = new StudySession({
        user: req.user.id,
        studySet: studySetId,
        sessionType,
        totalCards: studySet.cards.length,
        settings: {
          showImages: settings.showImages !== false,
          playAudio: settings.playAudio !== false,
          autoFlip: settings.autoFlip || false,
          shuffleCards: settings.shuffleCards || false
        }
      });

      await session.save();

      // Populate study set info
      await session.populate('studySet', 'title description cards');

      // Shuffle cards if requested
      let cards = [...session.studySet.cards];
      if (session.settings.shuffleCards) {
        cards = cards.sort(() => Math.random() - 0.5);
      }

      console.log('‚úÖ Study session created:', session._id);

      res.status(201).json({
        success: true,
        message: 'B·∫Øt ƒë·∫ßu phi√™n h·ªçc th√†nh c√¥ng!',
        data: {
          session: {
            ...session.toObject(),
            studySet: {
              ...session.studySet.toObject(),
              cards
            }
          }
        }
      });

    } catch (error) {
      console.error('‚ùå Start session error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi b·∫Øt ƒë·∫ßu phi√™n h·ªçc'
      });
    }
  },

  // Get active session
  getSession: async (req, res) => {
    try {
      const { sessionId } = req.params;

      const session = await StudySession.findById(sessionId)
        .populate('studySet', 'title description cards')
        .populate('user', 'firstName lastName');

      if (!session) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y phi√™n h·ªçc'
        });
      }

      // Check ownership
      if (session.user._id.toString() !== req.user.id.toString()) {
        return res.status(403).json({
          success: false,
          message: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p phi√™n h·ªçc n√†y'
        });
      }

      res.json({
        success: true,
        data: session
      });

    } catch (error) {
      console.error('‚ùå Get session error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi l·∫•y th√¥ng tin phi√™n h·ªçc'
      });
    }
  },

  // Answer a card
  answerCard: async (req, res) => {
    try {
      const { sessionId } = req.params;
      const { cardId, result, timeSpent = 0 } = req.body;

      console.log('üìù Answering card:', { sessionId, cardId, result, timeSpent });

      if (!['correct', 'incorrect', 'skipped'].includes(result)) {
        return res.status(400).json({
          success: false,
          message: 'K·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá'
        });
      }

      const session = await StudySession.findById(sessionId)
        .populate('studySet', 'cards');

      if (!session) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y phi√™n h·ªçc'
        });
      }

      if (session.user.toString() !== req.user.id.toString()) {
        return res.status(403).json({
          success: false,
          message: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p phi√™n h·ªçc n√†y'
        });
      }

      if (session.status !== 'active') {
        return res.status(400).json({
          success: false,
          message: 'Phi√™n h·ªçc ƒë√£ k·∫øt th√∫c'
        });
      }

      // Find the card
      const card = session.studySet.cards.id(cardId);
      if (!card) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y th·∫ª h·ªçc'
        });
      }

      // Check if card already answered
      const existingResult = session.cardResults.find(r => r.cardId.toString() === cardId);
      if (existingResult) {
        return res.status(400).json({
          success: false,
          message: 'Th·∫ª n√†y ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi'
        });
      }

      // Add card result
      const cardResult = {
        cardId: cardId,
        term: card.term,
        definition: card.definition,
        result: result,
        timeSpent: Math.max(0, timeSpent),
        answeredAt: new Date()
      };

      session.addCardResult(cardResult);

      // Move to next card
      session.currentCardIndex = Math.min(session.currentCardIndex + 1, session.totalCards - 1);

      await session.save();

      console.log('‚úÖ Card answered, session updated');

      res.json({
        success: true,
        message: 'ƒê√£ ghi nh·∫≠n c√¢u tr·∫£ l·ªùi',
        data: {
          session: {
            _id: session._id,
            currentCardIndex: session.currentCardIndex,
            cardsStudied: session.cardsStudied,
            completionPercentage: session.completionPercentage,
            stats: session.stats
          },
          nextCard: session.currentCardIndex < session.totalCards - 1
        }
      });

    } catch (error) {
      console.error('‚ùå Answer card error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi ghi nh·∫≠n c√¢u tr·∫£ l·ªùi'
      });
    }
  },

  // Complete session
  completeSession: async (req, res) => {
    try {
      const { sessionId } = req.params;

      const session = await StudySession.findById(sessionId)
        .populate('studySet', 'title description');

      if (!session) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y phi√™n h·ªçc'
        });
      }

      if (session.user.toString() !== req.user.id.toString()) {
        return res.status(403).json({
          success: false,
          message: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p phi√™n h·ªçc n√†y'
        });
      }

      if (session.status === 'completed') {
        return res.status(400).json({
          success: false,
          message: 'Phi√™n h·ªçc ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh'
        });
      }

      // Complete the session
      session.completeSession();
      await session.save();

      // Update user's study stats
      await User.findByIdAndUpdate(req.user.id, {
        $inc: {
          'stats.totalStudySessions': 1,
          'stats.totalCardsStudied': session.cardsStudied,
          'stats.totalStudyTime': session.stats.totalTimeSpent
        },
        lastStudyAt: new Date()
      });

      console.log('üéâ Study session completed:', session._id);

      res.json({
        success: true,
        message: 'Ho√†n th√†nh phi√™n h·ªçc th√†nh c√¥ng!',
        data: {
          session: {
            _id: session._id,
            completionPercentage: session.completionPercentage,
            accuracyPercentage: session.accuracyPercentage,
            stats: session.stats,
            totalTimeSpent: session.stats.totalTimeSpent,
            cardsStudied: session.cardsStudied,
            totalCards: session.totalCards,
            completedAt: session.completedAt
          }
        }
      });

    } catch (error) {
      console.error('‚ùå Complete session error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi ho√†n th√†nh phi√™n h·ªçc'
      });
    }
  },

  // Get user's study history
  getStudyHistory: async (req, res) => {
    try {
      const page = parseInt(req.query.page) || 1;
      const limit = parseInt(req.query.limit) || 10;
      const skip = (page - 1) * limit;

      const sessions = await StudySession.find({ 
        user: req.user.id,
        status: 'completed'
      })
        .populate('studySet', 'title description category')
        .sort({ completedAt: -1 })
        .skip(skip)
        .limit(limit);

      const total = await StudySession.countDocuments({ 
        user: req.user.id,
        status: 'completed'
      });

      res.json({
        success: true,
        data: {
          sessions,
          pagination: {
            current: page,
            pages: Math.ceil(total / limit),
            total,
            limit
          }
        }
      });

    } catch (error) {
      console.error('‚ùå Get study history error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi l·∫•y l·ªãch s·ª≠ h·ªçc t·∫≠p'
      });
    }
  },

  // Pause/Resume session
  pauseSession: async (req, res) => {
    try {
      const { sessionId } = req.params;
      const { action } = req.body; // 'pause' or 'resume'

      const session = await StudySession.findById(sessionId);

      if (!session) {
        return res.status(404).json({
          success: false,
          message: 'Kh√¥ng t√¨m th·∫•y phi√™n h·ªçc'
        });
      }

      if (session.user.toString() !== req.user.id.toString()) {
        return res.status(403).json({
          success: false,
          message: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p phi√™n h·ªçc n√†y'
        });
      }

      if (action === 'pause' && session.status === 'active') {
        session.status = 'paused';
      } else if (action === 'resume' && session.status === 'paused') {
        session.status = 'active';
      } else {
        return res.status(400).json({
          success: false,
          message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá'
        });
      }

      await session.save();

      res.json({
        success: true,
        message: action === 'pause' ? 'ƒê√£ t·∫°m d·ª´ng phi√™n h·ªçc' : 'ƒê√£ ti·∫øp t·ª•c phi√™n h·ªçc',
        data: {
          status: session.status
        }
      });

    } catch (error) {
      console.error('‚ùå Pause/Resume session error:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi thay ƒë·ªïi tr·∫°ng th√°i phi√™n h·ªçc'
      });
    }
  }
};

module.exports = studySessionController;